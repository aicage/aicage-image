name: Test Non-Redistributable Agents
run-name: Test non-redistributable agents (${{ github.ref_name }})

"on":
  push:
    tags:
      - "*"
  workflow_dispatch:
    inputs:
      base:
        description: Base alias to test (from bases.tar.gz release artifact)
        required: false
        type: string
      agent:
        description: Agent name to test (matches agents/<agent>)
        required: false
        type: string

concurrency:
  group: test-non-redistributable-agents-${{ github.ref_name }}
  cancel-in-progress: false

jobs:

  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: "Test: Set up Python"
        uses: actions/setup-python@v6.1.0
        with:
          python-version: "3.x"

      - name: "Test: Remove Python yq and keep using Go yq"
        run: |
          python -m pip uninstall -y yq

      - name: "Test: Install lint deps"
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: "Test: Run linters (yamllint, ruff, pymarkdown)"
        run: |
          yamllint .
          ruff check .
          pymarkdown --config .pymarkdown.json scan .

      - name: "Test: Validate config and agents with schemas"
        run: |
          check-jsonschema \
            --schemafile doc/validation/agent.schema.json \
            agents/*/agent.yaml
          check-jsonschema \
            --schemafile doc/validation/config.schema.json \
            config.yaml

  matrix:
    name: Generate matrix for non-redistributable agents
    runs-on: ubuntu-latest
    needs: lint
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_entries: ${{ steps.set-matrix.outputs.has_entries }}
    env:
      ROOT_DIR: ${{ github.workspace }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Generate matrix
        id: set-matrix
        env:
          REQUESTED_BASE: ${{ github.event.inputs.base }}
          REQUESTED_AGENT: ${{ github.event.inputs.agent }}
        run: |
          set -euo pipefail
          source scripts/common.sh
          load_config_file
          BASES_TMPDIR="$(download_bases_archive)"
          matrix_file="$(mktemp)"
          echo '{"include":[]}' > "${matrix_file}"
          count=0

          append_item() {
            local agent="$1"
            local base="$2"
            local arch="$3"
            local runner="$4"
            local platform="$5"

            jq -c \
              --arg agent "${agent}" \
              --arg base "${base}" \
              --arg arch "${arch}" \
              --arg runner "${runner}" \
              --arg platform "${platform}" \
              '
                .include += [{
                  "agent": $agent,
                  "base": $base,
                  "arch": $arch,
                  "runner": $runner,
                  "platform": $platform
                }]
              ' \
              "${matrix_file}" > "${matrix_file}.tmp"
            mv "${matrix_file}.tmp" "${matrix_file}"
          }

          for dir in agents/*; do
            [[ -d "${dir}" ]] || continue
            agent="$(basename "${dir}")"
            if is_agent_field_true "${agent}" redistributable; then
              continue
            fi
            bases="$(get_bases "${agent}" "${BASES_TMPDIR}/bases")"
            for base in ${bases}; do
              append_item "${agent}" "${base}" "amd64" "ubuntu-latest" "linux/amd64"
              append_item "${agent}" "${base}" "arm64" "ubuntu-24.04-arm" "linux/arm64"
              count=$((count + 2))
            done
          done

          if [[ -n "${REQUESTED_BASE}" || -n "${REQUESTED_AGENT}" ]]; then
            filtered_file="$(mktemp)"
            jq -c \
              --arg base "${REQUESTED_BASE}" \
              --arg agent "${REQUESTED_AGENT}" \
              '
                .include |= map(select(
                  ($agent == "" or .agent == $agent)
                  and ($base == "" or .base == $base)
                ))
              ' \
              "${matrix_file}" > "${filtered_file}"
            mv "${filtered_file}" "${matrix_file}"
            count="$(jq -r '.include | length' "${matrix_file}")"
            if [[ "${count}" -eq 0 ]]; then
              echo "No matching agent/base combinations for inputs." >&2
              exit 1
            fi
          fi

          matrix_json="$(cat "${matrix_file}")"
          {
            echo "matrix=${matrix_json}"
            if [[ "${count}" -gt 0 ]]; then
              echo "has_entries=true"
            else
              echo "has_entries=false"
            fi
          } >> "$GITHUB_OUTPUT"

  test-non-redistributable:
    name: "${{ matrix.arch }}: Test ${{ matrix.agent }}-${{ matrix.base }}"
    runs-on: ${{ matrix.runner }}
    needs: [matrix]
    if: ${{ needs.matrix.outputs.has_entries == 'true' }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.matrix.outputs.matrix) }}
    env:
      PLATFORM: ${{ matrix.platform }}
      ARCH: ${{ matrix.arch }}
      BASE_ALIAS: ${{ matrix.base }}
      AGENT: ${{ matrix.agent }}
      ROOT_DIR: ${{ github.workspace }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set base image and tag
        id: config
        run: |
          set -euo pipefail
          source scripts/common.sh
          load_config_file
          BASE_IMAGE="${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_BASE_REPOSITORY}:${BASE_ALIAS}"
          IMAGE_TAG="aicage-non-redistributable-test:${AGENT}-${BASE_ALIAS}-${ARCH}"
          {
            echo "BASE_IMAGE=${BASE_IMAGE}"
            echo "IMAGE_TAG=${IMAGE_TAG}"
          } >> "$GITHUB_OUTPUT"
          {
            echo "BASE_IMAGE=${BASE_IMAGE}"
            echo "IMAGE_TAG=${IMAGE_TAG}"
          } >> "$GITHUB_ENV"

      - name: "Set up Buildx"
        uses: docker/setup-buildx-action@v3.11.1
        with:
          driver: docker-container

      - name: Build image (local)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: true
          provenance: false
          build-args: |
            BASE_IMAGE=${{ env.BASE_IMAGE }}
            AGENT=${{ env.AGENT }}
          tags: |
            ${{ env.IMAGE_TAG }}

      - name: "Test: Setup BATS testing framework"
        uses: mig4/setup-bats@v1.2.0

      - name: "Test: Run smoke suites on non-redistributable image"
        run: |
          set -euo pipefail
          scripts/test.sh \
            --image "${IMAGE_TAG}" \
            --agent "${AGENT}"
