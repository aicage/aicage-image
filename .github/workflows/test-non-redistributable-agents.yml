name: Test Non-Redistributable Agents
run-name: Test non-redistributable agents (${{ github.ref_name }})

"on":
  workflow_call:
    inputs:
      matrix_images:
        description: JSON image matrix with include entries ({agent, base, arch, platform, runner})
        required: true
        type: string
  workflow_dispatch:
    inputs:
      matrix_images:
        description: JSON image matrix with include entries ({agent, base, arch, platform, runner})
        required: true
        default: >-
          {"include":[{"agent":"bar","base":"foo","arch":"amd64",
          "platform":"linux/amd64","runner":"ubuntu-latest"},{"agent":"bar",
          "base":"foo","arch":"arm64","platform":"linux/arm64",
          "runner":"ubuntu-24.04-arm"}]}
        type: string

concurrency:
  group: test-non-redistributable-agents-${{ github.ref_name }}
  cancel-in-progress: false

jobs:

  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: "Test: Set up Python"
        uses: actions/setup-python@v6.1.0
        with:
          python-version: "3.x"

      - name: "Test: Remove Python yq and keep using Go yq"
        run: |
          python -m pip uninstall -y yq

      - name: "Test: Install lint deps"
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: "Test: Run linters (yamllint, ruff, pymarkdown)"
        run: |
          yamllint .
          ruff check .
          pymarkdown --config .pymarkdown.json scan .

      - name: "Test: Validate config and agents with schemas"
        run: |
          check-jsonschema \
            --schemafile doc/validation/agent.schema.json \
            agents/*/agent.yaml
          check-jsonschema \
            --schemafile doc/validation/config.schema.json \
            config.yaml

  test-non-redistributable:
    name: "${{ matrix.arch }}: Test ${{ matrix.agent }}-${{ matrix.base }}"
    runs-on: ${{ matrix.runner }}
    needs: lint
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(inputs.matrix_images) }}
    env:
      PLATFORM: ${{ matrix.platform }}
      ARCH: ${{ matrix.arch }}
      BASE_ALIAS: ${{ matrix.base }}
      AGENT: ${{ matrix.agent }}
      ROOT_DIR: ${{ github.workspace }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set base image and tag
        id: config
        run: |
          set -euo pipefail
          source scripts/common.sh
          load_config_file
          BASE_IMAGE="${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_BASE_REPOSITORY}:${BASE_ALIAS}"
          IMAGE_TAG="aicage-non-redistributable-test:${AGENT}-${BASE_ALIAS}-${ARCH}"
          {
            echo "BASE_IMAGE=${BASE_IMAGE}"
            echo "IMAGE_TAG=${IMAGE_TAG}"
          } >> "$GITHUB_OUTPUT"
          {
            echo "BASE_IMAGE=${BASE_IMAGE}"
            echo "IMAGE_TAG=${IMAGE_TAG}"
          } >> "$GITHUB_ENV"

      - name: "Set up Buildx"
        uses: docker/setup-buildx-action@v3.11.1
        with:
          driver: docker-container

      - name: Build image (local)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: true
          provenance: false
          build-args: |
            BASE_IMAGE=${{ env.BASE_IMAGE }}
            AGENT=${{ env.AGENT }}
          tags: |
            ${{ env.IMAGE_TAG }}

      - name: "Test: Setup BATS testing framework"
        uses: mig4/setup-bats@v1.2.0

      - name: "Test: Run smoke suites on non-redistributable image"
        run: |
          set -euo pipefail
          scripts/test.sh \
            --image "${IMAGE_TAG}" \
            --agent "${AGENT}"
