name: Build Agent Image (Template)
run-name: Build ${{ inputs.agent }}-${{ inputs.base }}

"on":
  workflow_call:
    inputs:
      base:
        description: Base alias to build (from bases.tar.gz release artifact)
        required: true
        type: string
      agent:
        description: Agent name to build (matches agents/<agent>)
        required: true
        type: string
  workflow_dispatch:
    inputs:
      base:
        description: Base alias to build (from bases.tar.gz release artifact)
        required: true
        type: string
      agent:
        description: Agent name to build (matches agents/<agent>)
        required: true
        type: string

concurrency:
  group: build-${{ inputs.base }}-${{ inputs.agent }}
  cancel-in-progress: false

permissions:
  contents: read
  packages: write
  id-token: write

jobs:

  load_config:
    name: Load config file, set variables
    runs-on: ubuntu-latest
    env:
      BASE_ALIAS: ${{ inputs.base }}
      AGENT: ${{ inputs.agent }}
      ROOT_DIR: ${{ github.workspace }}
      AICAGE_VERSION: ${{ github.ref_name }}
    outputs:
      BASE_IMAGE: ${{ steps.config.outputs.BASE_IMAGE }}
      IMAGE_NAME: ${{ steps.config.outputs.IMAGE_NAME }}
      MANIFEST_VERSION_TAG: ${{ steps.config.outputs.MANIFEST_VERSION_TAG }}
      MANIFEST_LATEST_TAG: ${{ steps.config.outputs.MANIFEST_LATEST_TAG }}
      MANIFEST_TEST_TAG: ${{ steps.config.outputs.MANIFEST_TEST_TAG }}
      AGENT_PATH: ${{ steps.config.outputs.AGENT_PATH }}
      AGENT_FULL_NAME: ${{ steps.config.outputs.AGENT_FULL_NAME }}
      AGENT_HOMEPAGE: ${{ steps.config.outputs.AGENT_HOMEPAGE }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: "Test: Set up Python"
        uses: actions/setup-python@v6.1.0
        with:
          python-version: "3.x"

      - name: "Test: Remove Python yq and keep using Go yq"
        run: |
          python -m pip uninstall -y yq

      - name: "Test: Install lint deps"
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: "Test: Run linters (yamllint, ruff, pymarkdown)"
        run: |
          yamllint .
          ruff check .
          pymarkdown --config .pymarkdown.json scan .

      - name: "Test: Validate config and agents with schemas"
        run: |
          check-jsonschema \
            --schemafile doc/validation/agent.schema.json \
            agents/*/agent.yaml
          check-jsonschema \
            --schemafile doc/validation/config.schema.json \
            config.yaml

      - name: "Test: Validate agent"
        shell: bash
        run: |
          set -euo pipefail
          if [[ ! -d "agents/${AGENT}" ]]; then
            echo "Agent '${AGENT}' not found under agents/" >&2
            exit 1
          fi

      - name: Load config file
        id: config
        run: |
          set -euo pipefail
          source scripts/common.sh
          load_config_file
          if ! is_agent_field_true "${AGENT}" redistributable; then
            echo "Agent '${AGENT}' is non-redistributable; build.yml should not run for it." >&2
            exit 1
          fi
          AGENT_VERSION="$(agents/${AGENT}/version.sh)"
          if [[ -z "${AGENT_VERSION}" ]]; then
            echo "Agent version is empty for ${AGENT}" >&2
            exit 1
          fi
          BASE_IMAGE="${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_BASE_REPOSITORY}:${BASE_ALIAS}"
          IMAGE_NAME="${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_REPOSITORY}"
          MANIFEST_VERSION_TAG="${IMAGE_NAME}:${AGENT}-${AGENT_VERSION}-${BASE_ALIAS}-${AICAGE_VERSION}"
          MANIFEST_LATEST_TAG="${IMAGE_NAME}:${AGENT}-${BASE_ALIAS}"
          MANIFEST_TEST_TAG="${MANIFEST_VERSION_TAG}-test"
          BASES_TMPDIR="$(download_bases_archive)"
          ALLOWED_BASES="$(get_bases "${AGENT}" "${BASES_TMPDIR}/bases" "${BASE_ALIAS}")"
          if ! printf '%s\n' "${ALLOWED_BASES}" | grep -Fxq "${BASE_ALIAS}"; then
            echo "Base '${BASE_ALIAS}' is excluded for agent '${AGENT}'" >&2
            exit 1
          fi
          {
            echo "BASE_IMAGE=${BASE_IMAGE}"
            echo "IMAGE_NAME=${IMAGE_NAME}"
            echo "MANIFEST_VERSION_TAG=${MANIFEST_VERSION_TAG}"
            echo "MANIFEST_LATEST_TAG=${MANIFEST_LATEST_TAG}"
            echo "MANIFEST_TEST_TAG=${MANIFEST_TEST_TAG}"
            echo "AGENT_PATH=$(get_agent_field "${AGENT}" agent_path)"
            echo "AGENT_FULL_NAME=$(get_agent_field "${AGENT}" agent_full_name)"
            echo "AGENT_HOMEPAGE=$(get_agent_field "${AGENT}" agent_homepage)"
          } >> "$GITHUB_OUTPUT"

  build:
    name: "${{ matrix.arch }}: Build, test, and publish ${{ inputs.base }}-${{ inputs.agent }}"
    runs-on: ${{ matrix.runner }}
    needs: load_config
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            platform: linux/amd64
            runner: ubuntu-latest
          - arch: arm64
            platform: linux/arm64
            runner: ubuntu-24.04-arm
    env:
      PLATFORM: ${{ matrix.platform }}
      ARCH_SUFFIX: ${{ matrix.arch }}
      BASE_ALIAS: ${{ inputs.base }}
      BASE_IMAGE: ${{ needs.load_config.outputs.BASE_IMAGE }}
      IMAGE_NAME: ${{ needs.load_config.outputs.IMAGE_NAME }}
      MANIFEST_VERSION_TAG: ${{ needs.load_config.outputs.MANIFEST_VERSION_TAG }}
      MANIFEST_LATEST_TAG: ${{ needs.load_config.outputs.MANIFEST_LATEST_TAG }}
      AGENT: ${{ inputs.agent }}
      AGENT_PATH: ${{ needs.load_config.outputs.AGENT_PATH }}
      AGENT_FULL_NAME: ${{ needs.load_config.outputs.AGENT_FULL_NAME }}
      AGENT_HOMEPAGE: ${{ needs.load_config.outputs.AGENT_HOMEPAGE }}
    outputs:
      AICAGE_IMAGE_DIGEST_amd64: ${{ steps.out.outputs.AICAGE_IMAGE_DIGEST_amd64 }}
      AICAGE_IMAGE_DIGEST_arm64: ${{ steps.out.outputs.AICAGE_IMAGE_DIGEST_arm64 }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: Set config
        id: config
        shell: bash
        run: |
          set -euo pipefail
          IMAGE_VERSION_TAG="${MANIFEST_VERSION_TAG}-${ARCH_SUFFIX}"
          IMAGE_LATEST_TAG="${MANIFEST_LATEST_TAG}-${ARCH_SUFFIX}"
          IMAGE_TEST_TAG="${IMAGE_VERSION_TAG}-test"
          {
            echo "IMAGE_VERSION_TAG=${IMAGE_VERSION_TAG}"
            echo "IMAGE_LATEST_TAG=${IMAGE_LATEST_TAG}"
            echo "IMAGE_TEST_TAG=${IMAGE_TEST_TAG}"
          } >> "$GITHUB_OUTPUT"
          {
            echo "IMAGE_VERSION_TAG=${IMAGE_VERSION_TAG}"
            echo "IMAGE_LATEST_TAG=${IMAGE_LATEST_TAG}"
            echo "IMAGE_TEST_TAG=${IMAGE_TEST_TAG}"
          } >> "$GITHUB_ENV"

      - name: "Set up Buildx"
        uses: docker/setup-buildx-action@v3.11.1
        with:
          driver: docker-container

      - name: "Log in to Docker Hub"
        uses: docker/login-action@v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build test image tag
        id: build_image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          provenance: true
          build-args: |
            BASE_IMAGE=${{ env.BASE_IMAGE }}
            AGENT=${{ env.AGENT }}
          tags: |
            ${{ steps.config.outputs.IMAGE_TEST_TAG }}
          labels: |
            org.opencontainers.image.description=Agent image for ${{ env.AGENT }}
            org.aicage.agent.agent_path=${{ env.AGENT_PATH }}
            org.aicage.agent.agent_full_name=${{ env.AGENT_FULL_NAME }}
            org.aicage.agent.agent_homepage=${{ env.AGENT_HOMEPAGE }}

      - name: "Test: Setup BATS testing framework"
        uses: mig4/setup-bats@v1.2.0

      - name: "Test: Run smoke suites on final image"
        run: |
          set -euo pipefail
          scripts/test.sh \
            --image "${IMAGE_NAME}@${{ steps.build_image.outputs.digest }}" \
            --agent "${AGENT}"

      - name: Install Cosign
        uses: sigstore/cosign-installer@v4.0.0

      - name: Sign image with cosign
        run: |
          set -euo pipefail
          cosign sign --yes \
            "${IMAGE_NAME}@${{ steps.build_image.outputs.digest }}"

      - name: Verify image signature
        run: |
          set -euo pipefail
          cosign verify \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            --certificate-identity-regexp \
              "^https://github.com/${GITHUB_REPOSITORY}/.github/workflows/.*@refs/.*/.*$" \
            "${IMAGE_NAME}@${{ steps.build_image.outputs.digest }}"

      - name: "Publish: Set architecture-specific image tag"
        run: |
          set -euo pipefail
          # Promote the already-built & provenanced artifact by digest (no rebuild)
          docker buildx imagetools create \
            --tag "${IMAGE_VERSION_TAG}" \
            --tag "${IMAGE_LATEST_TAG}" \
            "${IMAGE_NAME}@${{ steps.build_image.outputs.digest }}"

      - name: Install ORAS
        uses: oras-project/setup-oras@v1

      - name: Delete test image tag
        run: |
          set -euo pipefail
          oras manifest delete "${IMAGE_TEST_TAG}"

      - id: out
        name: Output variables
        run: |
          set -euo pipefail
          echo "AICAGE_IMAGE_DIGEST_${{ matrix.arch }}=${{ steps.build_image.outputs.digest }}" >> "$GITHUB_OUTPUT"
          echo "AICAGE_IMAGE_DIGEST=${{ steps.build_image.outputs.digest }}" >> "$GITHUB_OUTPUT"

  manifest:
    name: Publish multi-arch manifest ${{ inputs.base }}-${{ inputs.agent }}
    runs-on: ubuntu-latest
    needs: [load_config, build]
    env:
      MANIFEST_VERSION_TAG: ${{ needs.load_config.outputs.MANIFEST_VERSION_TAG }}
      MANIFEST_LATEST_TAG: ${{ needs.load_config.outputs.MANIFEST_LATEST_TAG }}
      MANIFEST_TEST_TAG: ${{ needs.load_config.outputs.MANIFEST_TEST_TAG }}
      AICAGE_IMAGE_DIGEST_amd64: ${{ needs.build.outputs.AICAGE_IMAGE_DIGEST_amd64 }}
      AICAGE_IMAGE_DIGEST_arm64: ${{ needs.build.outputs.AICAGE_IMAGE_DIGEST_arm64 }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: "Set up Buildx"
        uses: docker/setup-buildx-action@v3.11.1
        with:
          driver: docker-container

      - name: "Log in to Docker Hub"
        uses: docker/login-action@v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "Publish: Create and push multi-arch manifest"
        id: build_manifest
        run: |
          set -euo pipefail
          docker buildx imagetools create \
              --tag "${MANIFEST_TEST_TAG}" \
              "${AICAGE_IMAGE_DIGEST_amd64}" \
              "${AICAGE_IMAGE_DIGEST_arm64}"

      - name: Install Cosign
        uses: sigstore/cosign-installer@v4.0.0

      - name: "Publish: Sign multi-arch manifest"
        run: |
          set -euo pipefail
          cosign sign --yes \
            "${MANIFEST_TEST_TAG}"

      - name: "Test: Verify multi-arch manifest signature"
        run: |
          set -euo pipefail
          cosign verify \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            --certificate-identity-regexp \
              "^https://github.com/${GITHUB_REPOSITORY}/.github/workflows/.*@refs/.*/.*$" \
            "${MANIFEST_TEST_TAG}"

      - name: "Publish: Set tags for multi-arch manifest"
        run: |
          set -euo pipefail
          # Promote the already-built & provenanced artifact by digest (no rebuild)
          docker buildx imagetools create \
            --tag "${MANIFEST_VERSION_TAG}" \
            --tag "${MANIFEST_LATEST_TAG}" \
            "${MANIFEST_TEST_TAG}"

      - name: Install ORAS
        uses: oras-project/setup-oras@v1

      - name: Delete test image tag
        run: |
          set -euo pipefail
          oras manifest delete "${MANIFEST_TEST_TAG}"
