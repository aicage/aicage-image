name: Build Agent Image (Template)
run-name: Build ${{ inputs.tool }}-${{ inputs.base }}

"on":
  workflow_call:
    inputs:
      base:
        description: Base alias to build (from scripts/common.sh discover_base_aliases)
        required: true
        type: string
      tool:
        description: Tool name to build (matches tools/<tool>)
        required: true
        type: string
  workflow_dispatch:
    inputs:
      base:
        description: Base alias to build (from scripts/common.sh discover_base_aliases)
        required: true
        type: string
      tool:
        description: Tool name to build (matches tools/<tool>)
        required: true
        type: string

concurrency:
  group: build-${{ inputs.base }}-${{ inputs.tool }}
  cancel-in-progress: true

jobs:

  load_config:
    name: Load config file, set variables
    runs-on: ubuntu-latest
    env:
      BASE_ALIAS: ${{ inputs.base }}
      TOOL: ${{ inputs.tool }}
      ROOT_DIR: ${{ github.workspace }}
    outputs:
      AICAGE_IMAGE_REGISTRY: ${{ steps.config.outputs.AICAGE_IMAGE_REGISTRY }}
      AICAGE_IMAGE_BASE_REPOSITORY: ${{ steps.config.outputs.AICAGE_IMAGE_BASE_REPOSITORY }}
      AICAGE_IMAGE_REPOSITORY: ${{ steps.config.outputs.AICAGE_IMAGE_REPOSITORY }}
      BASE_IMAGE: ${{ steps.config.outputs.BASE_IMAGE }}
      TOOL_PATH: ${{ steps.config.outputs.TOOL_PATH }}
      TOOL_FULL_NAME: ${{ steps.config.outputs.TOOL_FULL_NAME }}
      TOOL_HOMEPAGE: ${{ steps.config.outputs.TOOL_HOMEPAGE }}
      TOOL_VERSION: ${{ steps.config.outputs.TOOL_VERSION }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Validate tool
        shell: bash
        run: |
          set -euo pipefail
          if [[ ! -d "tools/${TOOL}" ]]; then
            echo "Tool '${TOOL}' not found under tools/" >&2
            exit 1
          fi

      - name: Load config file
        id: config
        run: |
          set -euo pipefail
          source scripts/common.sh
          load_config_file
          TOOL_VERSION="$(tools/${TOOL}/version.sh)"
          if [[ -z "${TOOL_VERSION}" ]]; then
            echo "Tool version is empty for ${TOOL}" >&2
            exit 1
          fi
          {
            echo "AICAGE_IMAGE_REGISTRY=${AICAGE_IMAGE_REGISTRY}"
            echo "AICAGE_IMAGE_BASE_REPOSITORY=${AICAGE_IMAGE_BASE_REPOSITORY}"
            echo "AICAGE_IMAGE_REPOSITORY=${AICAGE_IMAGE_REPOSITORY}"
            echo "BASE_IMAGE=${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_BASE_REPOSITORY}:${BASE_ALIAS}-latest"
            echo "TOOL_PATH=$(get_tool_field "${TOOL}" tool_path)"
            echo "TOOL_FULL_NAME=$(get_tool_field "${TOOL}" tool_full_name)"
            echo "TOOL_HOMEPAGE=$(get_tool_field "${TOOL}" tool_homepage)"
            echo "TOOL_VERSION=${TOOL_VERSION}"
          } >> "$GITHUB_OUTPUT"

  build:
    name: "${{ matrix.arch }}: Build, test, and publish ${{ inputs.base }}-${{ inputs.tool }}"
    runs-on: ${{ matrix.runner }}
    needs: load_config
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            platform: linux/amd64
            runner: ubuntu-latest
          - arch: arm64
            platform: linux/arm64
            runner: ubuntu-24.04-arm
    env:
      PLATFORM: ${{ matrix.platform }}
      ARCH_SUFFIX: ${{ matrix.arch }}
      BASE_ALIAS: ${{ inputs.base }}
      BASE_IMAGE: ${{ needs.load_config.outputs.BASE_IMAGE }}
      TOOL: ${{ inputs.tool }}
      TOOL_PATH: ${{ needs.load_config.outputs.TOOL_PATH }}
      TOOL_FULL_NAME: ${{ needs.load_config.outputs.TOOL_FULL_NAME }}
      TOOL_HOMEPAGE: ${{ needs.load_config.outputs.TOOL_HOMEPAGE }}
      TOOL_VERSION: ${{ needs.load_config.outputs.TOOL_VERSION }}
      AICAGE_IMAGE_REGISTRY: ${{ needs.load_config.outputs.AICAGE_IMAGE_REGISTRY }}
      AICAGE_IMAGE_REPOSITORY: ${{ needs.load_config.outputs.AICAGE_IMAGE_REPOSITORY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: Set config
        id: config
        shell: bash
        run: |
          set -euo pipefail
          VERSION_TAG="${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_REPOSITORY}:${TOOL}-${BASE_ALIAS}-${ARCH_SUFFIX}-${TOOL_VERSION}"
          LATEST_TAG="${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_REPOSITORY}:${TOOL}-${BASE_ALIAS}-${ARCH_SUFFIX}-latest"
          {
            echo "VERSION_TAG=${VERSION_TAG}"
            echo "LATEST_TAG=${LATEST_TAG}"
          } >> "$GITHUB_OUTPUT"
          {
            echo "VERSION_TAG=${VERSION_TAG}"
            echo "LATEST_TAG=${LATEST_TAG}"
          } >> "$GITHUB_ENV"

      - name: Build (local only, leaves image on runner)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: true
          build-args: |
            BASE_IMAGE=${{ env.BASE_IMAGE }}
            TOOL=${{ env.TOOL }}
          tags: |
            ${{ steps.config.outputs.VERSION_TAG }}
            ${{ steps.config.outputs.LATEST_TAG }}
          labels: |
            org.opencontainers.image.description=Agent image for ${{ env.TOOL }}
            org.aicage.tool.tool_path=${{ env.TOOL_PATH }}
            org.aicage.tool.tool_full_name=${{ env.TOOL_FULL_NAME }}
            org.aicage.tool.tool_homepage=${{ env.TOOL_HOMEPAGE }}

      - name: "Test: Setup BATS testing framework"
        uses: mig4/setup-bats@v1.2.0

      - name: "Test: Run smoke suites on final image"
        run: |
          set -euo pipefail
          scripts/test.sh --image "${VERSION_TAG}" --tool "${TOOL}"

      - name: "Publish: Log in to Docker Hub"
        uses: docker/login-action@v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "Publish: Push architecture-specific image"
        run: |
          set -euo pipefail
          docker push "${VERSION_TAG}"
          docker push "${LATEST_TAG}"


  manifest:
    name: Publish multi-arch manifest ${{ inputs.base }}-${{ inputs.tool }}
    runs-on: ubuntu-latest
    needs: [load_config, build]
    env:
      TOOL: ${{ inputs.tool }}
      BASE_ALIAS: ${{ inputs.base }}
      AICAGE_IMAGE_REGISTRY: ${{ needs.load_config.outputs.AICAGE_IMAGE_REGISTRY }}
      AICAGE_IMAGE_REPOSITORY: ${{ needs.load_config.outputs.AICAGE_IMAGE_REPOSITORY }}
      TOOL_VERSION: ${{ needs.load_config.outputs.TOOL_VERSION }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: "Set up Buildx"
        uses: docker/setup-buildx-action@v3.11.1
        with:
          driver: docker-container

      - name: "Log in to Docker Hub"
        uses: docker/login-action@v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "Create and push multi-arch manifest"
        run: |
          set -euo pipefail
          VERSION_TAG="${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_REPOSITORY}:${TOOL}-${BASE_ALIAS}-${TOOL_VERSION}"
          LATEST_TAG="${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_REPOSITORY}:${TOOL}-${BASE_ALIAS}-latest"

          amd64_tag="${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_REPOSITORY}:${TOOL}-${BASE_ALIAS}-amd64-${TOOL_VERSION}"
          arm64_tag="${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_REPOSITORY}:${TOOL}-${BASE_ALIAS}-arm64-${TOOL_VERSION}"

          docker buildx imagetools create \
            --tag "${VERSION_TAG}" \
            --tag "${LATEST_TAG}" \
            "${amd64_tag}" \
            "${arm64_tag}"

          for tag in "${VERSION_TAG}" "${LATEST_TAG}"; do
            echo "Inspect tag '${tag}':"
            docker buildx imagetools inspect "${tag}"
          done
