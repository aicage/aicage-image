name: Build Agent Image (Template)
run-name: Build ${{ inputs.agent }}-${{ inputs.base }}

"on":
  workflow_call:
    inputs:
      base:
        description: Base alias to build (from bases.tar.gz release artifact)
        required: true
        type: string
      agent:
        description: Agent name to build (matches agents/<agent>)
        required: true
        type: string
  workflow_dispatch:
    inputs:
      base:
        description: Base alias to build (from bases.tar.gz release artifact)
        required: true
        type: string
      agent:
        description: Agent name to build (matches agents/<agent>)
        required: true
        type: string

concurrency:
  group: build-${{ inputs.base }}-${{ inputs.agent }}
  cancel-in-progress: false

jobs:

  load_config:
    name: Load config file, set variables
    runs-on: ubuntu-latest
    env:
      BASE_ALIAS: ${{ inputs.base }}
      AGENT: ${{ inputs.agent }}
      ROOT_DIR: ${{ github.workspace }}
    outputs:
      AICAGE_IMAGE_REGISTRY: ${{ steps.config.outputs.AICAGE_IMAGE_REGISTRY }}
      AICAGE_IMAGE_BASE_REPOSITORY: ${{ steps.config.outputs.AICAGE_IMAGE_BASE_REPOSITORY }}
      AICAGE_IMAGE_REPOSITORY: ${{ steps.config.outputs.AICAGE_IMAGE_REPOSITORY }}
      BASE_IMAGE: ${{ steps.config.outputs.BASE_IMAGE }}
      AGENT_PATH: ${{ steps.config.outputs.AGENT_PATH }}
      AGENT_FULL_NAME: ${{ steps.config.outputs.AGENT_FULL_NAME }}
      AGENT_HOMEPAGE: ${{ steps.config.outputs.AGENT_HOMEPAGE }}
      AGENT_VERSION: ${{ steps.config.outputs.AGENT_VERSION }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: "Test: Set up Python"
        uses: actions/setup-python@v6.1.0
        with:
          python-version: "3.x"

      - name: "Test: Remove Python yq and keep using Go yq"
        run: |
          python -m pip uninstall -y yq

      - name: "Test: Install lint deps"
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: "Test: Run linters (yamllint, ruff, pymarkdown)"
        run: |
          yamllint .
          ruff check .
          pymarkdown --config .pymarkdown.json scan .

      - name: "Test: Validate config and agents with schemas"
        run: |
          check-jsonschema \
            --schemafile doc/validation/agent.schema.json \
            agents/*/agent.yaml
          check-jsonschema \
            --schemafile doc/validation/config.schema.json \
            config.yaml

      - name: "Test: Validate agent"
        shell: bash
        run: |
          set -euo pipefail
          if [[ ! -d "agents/${AGENT}" ]]; then
            echo "Agent '${AGENT}' not found under agents/" >&2
            exit 1
          fi

      - name: Load config file
        id: config
        run: |
          set -euo pipefail
          source scripts/common.sh
          load_config_file
          AGENT_VERSION="$(agents/${AGENT}/version.sh)"
          if [[ -z "${AGENT_VERSION}" ]]; then
            echo "Agent version is empty for ${AGENT}" >&2
            exit 1
          fi
          BASES_TMPDIR="$(download_bases_archive)"
          ALLOWED_BASES="$(get_bases "${AGENT}" "${BASES_TMPDIR}/bases" "${BASE_ALIAS}")"
          if ! printf '%s\n' "${ALLOWED_BASES}" | grep -Fxq "${BASE_ALIAS}"; then
            echo "Base '${BASE_ALIAS}' is excluded for agent '${AGENT}'" >&2
            exit 1
          fi
          {
            echo "AICAGE_IMAGE_REGISTRY=${AICAGE_IMAGE_REGISTRY}"
            echo "AICAGE_IMAGE_BASE_REPOSITORY=${AICAGE_IMAGE_BASE_REPOSITORY}"
            echo "AICAGE_IMAGE_REPOSITORY=${AICAGE_IMAGE_REPOSITORY}"
            echo "BASE_IMAGE=${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_BASE_REPOSITORY}:${BASE_ALIAS}-latest"
            echo "AGENT_PATH=$(get_agent_field "${AGENT}" agent_path)"
            echo "AGENT_FULL_NAME=$(get_agent_field "${AGENT}" agent_full_name)"
            echo "AGENT_HOMEPAGE=$(get_agent_field "${AGENT}" agent_homepage)"
            echo "AGENT_VERSION=${AGENT_VERSION}"
          } >> "$GITHUB_OUTPUT"

  build:
    name: "${{ matrix.arch }}: Build, test, and publish ${{ inputs.base }}-${{ inputs.agent }}"
    runs-on: ${{ matrix.runner }}
    needs: load_config
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            platform: linux/amd64
            runner: ubuntu-latest
          - arch: arm64
            platform: linux/arm64
            runner: ubuntu-24.04-arm
    env:
      PLATFORM: ${{ matrix.platform }}
      ARCH_SUFFIX: ${{ matrix.arch }}
      BASE_ALIAS: ${{ inputs.base }}
      BASE_IMAGE: ${{ needs.load_config.outputs.BASE_IMAGE }}
      AGENT: ${{ inputs.agent }}
      AGENT_PATH: ${{ needs.load_config.outputs.AGENT_PATH }}
      AGENT_FULL_NAME: ${{ needs.load_config.outputs.AGENT_FULL_NAME }}
      AGENT_HOMEPAGE: ${{ needs.load_config.outputs.AGENT_HOMEPAGE }}
      AGENT_VERSION: ${{ needs.load_config.outputs.AGENT_VERSION }}
      AICAGE_IMAGE_REGISTRY: ${{ needs.load_config.outputs.AICAGE_IMAGE_REGISTRY }}
      AICAGE_IMAGE_REPOSITORY: ${{ needs.load_config.outputs.AICAGE_IMAGE_REPOSITORY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: Set config
        id: config
        shell: bash
        run: |
          set -euo pipefail
          VERSION_TAG="${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_REPOSITORY}:${AGENT}-${BASE_ALIAS}-${ARCH_SUFFIX}-${AGENT_VERSION}"
          LATEST_TAG="${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_REPOSITORY}:${AGENT}-${BASE_ALIAS}-${ARCH_SUFFIX}-latest"
          {
            echo "VERSION_TAG=${VERSION_TAG}"
            echo "LATEST_TAG=${LATEST_TAG}"
          } >> "$GITHUB_OUTPUT"
          {
            echo "VERSION_TAG=${VERSION_TAG}"
            echo "LATEST_TAG=${LATEST_TAG}"
          } >> "$GITHUB_ENV"

      - name: Build (local only, leaves image on runner)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: true
          build-args: |
            BASE_IMAGE=${{ env.BASE_IMAGE }}
            AGENT=${{ env.AGENT }}
          tags: |
            ${{ steps.config.outputs.VERSION_TAG }}
            ${{ steps.config.outputs.LATEST_TAG }}
          labels: |
            org.opencontainers.image.description=Agent image for ${{ env.AGENT }}
            org.aicage.agent.agent_path=${{ env.AGENT_PATH }}
            org.aicage.agent.agent_full_name=${{ env.AGENT_FULL_NAME }}
            org.aicage.agent.agent_homepage=${{ env.AGENT_HOMEPAGE }}

      - name: "Test: Setup BATS testing framework"
        uses: mig4/setup-bats@v1.2.0

      - name: "Test: Run smoke suites on final image"
        run: |
          set -euo pipefail
          scripts/test.sh --image "${VERSION_TAG}" --agent "${AGENT}"

      - name: "Publish: Log in to Docker Hub"
        uses: docker/login-action@v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "Publish: Push architecture-specific image"
        run: |
          set -euo pipefail
          docker push "${VERSION_TAG}"
          docker push "${LATEST_TAG}"


  manifest:
    name: Publish multi-arch manifest ${{ inputs.base }}-${{ inputs.agent }}
    runs-on: ubuntu-latest
    needs: [load_config, build]
    env:
      AGENT: ${{ inputs.agent }}
      BASE_ALIAS: ${{ inputs.base }}
      AICAGE_IMAGE_REGISTRY: ${{ needs.load_config.outputs.AICAGE_IMAGE_REGISTRY }}
      AICAGE_IMAGE_REPOSITORY: ${{ needs.load_config.outputs.AICAGE_IMAGE_REPOSITORY }}
      AGENT_VERSION: ${{ needs.load_config.outputs.AGENT_VERSION }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: "Set up Buildx"
        uses: docker/setup-buildx-action@v3.11.1
        with:
          driver: docker-container

      - name: "Log in to Docker Hub"
        uses: docker/login-action@v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "Create and push multi-arch manifest"
        run: |
          set -euo pipefail
          VERSION_TAG="${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_REPOSITORY}:${AGENT}-${BASE_ALIAS}-${AGENT_VERSION}"
          LATEST_TAG="${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_REPOSITORY}:${AGENT}-${BASE_ALIAS}-latest"

          amd64_tag="${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_REPOSITORY}:${AGENT}-${BASE_ALIAS}-amd64-${AGENT_VERSION}"
          arm64_tag="${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_REPOSITORY}:${AGENT}-${BASE_ALIAS}-arm64-${AGENT_VERSION}"

          docker buildx imagetools create \
            --tag "${VERSION_TAG}" \
            --tag "${LATEST_TAG}" \
            "${amd64_tag}" \
            "${arm64_tag}"

          for tag in "${VERSION_TAG}" "${LATEST_TAG}"; do
            echo "Inspect tag '${tag}':"
            docker buildx imagetools inspect "${tag}"
          done
