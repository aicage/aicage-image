name: Build Agent Images
run-name: Build agent images (${{ github.ref_name }})

"on":
  workflow_call:
    inputs:
      git_ref:
        description: Git ref to check out (tag/branch/SHA). Defaults to the workflow ref.
        required: false
        default: ""
        type: string
      matrix_images:
        description: JSON image matrix with include entries ({agent, base, arch, platform, runner})
        required: true
        type: string
      matrix_manifests:
        description: JSON manifest matrix with include entries ({agent, base})
        required: true
        type: string
  workflow_dispatch:
    inputs:
      matrix_images:
        description: JSON image matrix with include entries ({agent, base, arch, platform, runner})
        required: true
        default: >-
          {"include":[{"agent":"bar","base":"foo","arch":"amd64",
          "platform":"linux/amd64","runner":"ubuntu-latest"},{"agent":"bar",
          "base":"foo","arch":"arm64","platform":"linux/arm64",
          "runner":"ubuntu-24.04-arm"}]}
        type: string
      matrix_manifests:
        description: JSON manifest matrix with include entries ({agent, base})
        required: true
        default: '{"include":[{"agent":"bar","base":"foo"}]}'
        type: string

concurrency:
  group: build-${{ github.run_id }}
  cancel-in-progress: false

permissions:
  contents: read
  packages: write
  id-token: write

jobs:

  build:
    name: "${{ matrix.arch }}: Build, test, and publish ${{ matrix.base }}-${{ matrix.agent }}"
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(inputs.matrix_images) }}
    env:
      PLATFORM: ${{ matrix.platform }}
      ARCH_SUFFIX: ${{ matrix.arch }}
      BASE_ALIAS: ${{ matrix.base }}
      AGENT: ${{ matrix.agent }}
      ROOT_DIR: ${{ github.workspace }}
      AICAGE_VERSION: ${{ inputs.git_ref || github.ref_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1
        with:
          ref: ${{ inputs.git_ref || github.ref }}

      - name: Install Cosign
        uses: sigstore/cosign-installer@v4.0.0

      - name: Load config file
        id: config
        run: |
          set -euo pipefail
          source scripts/common.sh
          load_config_file
          if is_agent_field_true "${AGENT}" build_local; then
            echo "Agent '${AGENT}' is non-redistributable; build.yml should not run for it." >&2
            exit 1
          fi
          AGENT_VERSION="$(agents/${AGENT}/version.sh)"
          if [[ -z "${AGENT_VERSION}" ]]; then
            echo "Agent version is empty for ${AGENT}" >&2
            exit 1
          fi
          BASE_IMAGE="${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_BASE_REPOSITORY}:${BASE_ALIAS}"
          IMAGE_NAME="${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_REPOSITORY}"
          MANIFEST_VERSION_TAG="${IMAGE_NAME}:${AGENT}-${AGENT_VERSION}-${BASE_ALIAS}-${AICAGE_VERSION}"
          MANIFEST_LATEST_TAG="${IMAGE_NAME}:${AGENT}-${BASE_ALIAS}"
          IMAGE_VERSION_TAG="${MANIFEST_VERSION_TAG}-${ARCH_SUFFIX}"
          IMAGE_LATEST_TAG="${MANIFEST_LATEST_TAG}-${ARCH_SUFFIX}"
          IMAGE_TEST_TAG="${IMAGE_VERSION_TAG}-test"

          BASES_TMPDIR="$(download_bases_archive)"
          ALLOWED_BASES="$(get_bases "${AGENT}" "${BASES_TMPDIR}/bases" "${BASE_ALIAS}")"
          if ! printf '%s\n' "${ALLOWED_BASES}" | grep -Fxq "${BASE_ALIAS}"; then
            echo "Base '${BASE_ALIAS}' is excluded for agent '${AGENT}'" >&2
            exit 1
          fi
          {
            echo "BASE_IMAGE=${BASE_IMAGE}"
            echo "IMAGE_NAME=${IMAGE_NAME}"
            echo "MANIFEST_VERSION_TAG=${MANIFEST_VERSION_TAG}"
            echo "MANIFEST_LATEST_TAG=${MANIFEST_LATEST_TAG}"
            echo "IMAGE_VERSION_TAG=${IMAGE_VERSION_TAG}"
            echo "IMAGE_LATEST_TAG=${IMAGE_LATEST_TAG}"
            echo "IMAGE_TEST_TAG=${IMAGE_TEST_TAG}"
          } >> "$GITHUB_OUTPUT"
          {
            echo "BASE_IMAGE=${BASE_IMAGE}"
            echo "IMAGE_NAME=${IMAGE_NAME}"
            echo "MANIFEST_VERSION_TAG=${MANIFEST_VERSION_TAG}"
            echo "MANIFEST_LATEST_TAG=${MANIFEST_LATEST_TAG}"
            echo "IMAGE_VERSION_TAG=${IMAGE_VERSION_TAG}"
            echo "IMAGE_LATEST_TAG=${IMAGE_LATEST_TAG}"
            echo "IMAGE_TEST_TAG=${IMAGE_TEST_TAG}"
          } >> "$GITHUB_ENV"

      - name: "Set up Buildx"
        uses: docker/setup-buildx-action@v3.11.1
        with:
          driver: docker-container

      - name: "Log in to Docker Hub"
        uses: docker/login-action@v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build test image tag
        id: build_image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          provenance: true
          build-args: |
            BASE_IMAGE=${{ env.BASE_IMAGE }}
            AGENT=${{ env.AGENT }}
          tags: |
            ${{ steps.config.outputs.IMAGE_TEST_TAG }}
          labels: |
            org.opencontainers.image.description=Agent image for ${{ env.AGENT }}

      - name: "Test: Setup BATS testing framework"
        uses: mig4/setup-bats@v1.2.0

      - name: "Test: Run smoke suites on final image"
        run: |
          set -euo pipefail
          scripts/test.sh \
            --image "${IMAGE_NAME}@${{ steps.build_image.outputs.digest }}" \
            --agent "${AGENT}"

      - name: Install Cosign
        uses: sigstore/cosign-installer@v4.0.0

      - name: Sign image with cosign
        run: |
          set -euo pipefail
          cosign sign --yes \
            "${IMAGE_NAME}@${{ steps.build_image.outputs.digest }}"

      - name: Verify image signature
        run: |
          set -euo pipefail
          cosign verify \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            --certificate-identity-regexp \
              "^https://github.com/${GITHUB_REPOSITORY}/.github/workflows/.*@refs/.*/.*$" \
            "${IMAGE_NAME}@${{ steps.build_image.outputs.digest }}"

      - name: "Publish: Set architecture-specific image tag"
        run: |
          set -euo pipefail
          # Promote the already-built & provenanced artifact by digest (no rebuild)
          docker buildx imagetools create \
            --tag "${IMAGE_VERSION_TAG}" \
            --tag "${IMAGE_LATEST_TAG}" \
            "${IMAGE_NAME}@${{ steps.build_image.outputs.digest }}"

      - name: Install ORAS
        uses: oras-project/setup-oras@v1

      - name: Delete test image tag
        run: |
          set -euo pipefail
          oras manifest delete "${IMAGE_TEST_TAG}"

      - name: Save image digest
        run: |
          set -euo pipefail
          printf '%s\n' "${{ steps.build_image.outputs.digest }}" > digest.txt

      - name: Upload image digest
        uses: actions/upload-artifact@v4
        with:
          name: digest-${{ matrix.agent }}-${{ matrix.base }}-${{ matrix.arch }}
          path: digest.txt
          retention-days: 1

  manifest:
    name: Publish multi-arch manifest ${{ matrix.base }}-${{ matrix.agent }}
    runs-on: ubuntu-latest
    needs: build
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(inputs.matrix_manifests) }}
    env:
      BASE_ALIAS: ${{ matrix.base }}
      AGENT: ${{ matrix.agent }}
      ROOT_DIR: ${{ github.workspace }}
      AICAGE_VERSION: ${{ inputs.git_ref || github.ref_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1
        with:
          ref: ${{ inputs.git_ref || github.ref }}

      - name: Load config file
        id: config
        run: |
          set -euo pipefail
          source scripts/common.sh
          load_config_file
          AGENT_VERSION="$(agents/${AGENT}/version.sh)"
          if [[ -z "${AGENT_VERSION}" ]]; then
            echo "Agent version is empty for ${AGENT}" >&2
            exit 1
          fi
          IMAGE_NAME="${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_REPOSITORY}"
          MANIFEST_VERSION_TAG="${IMAGE_NAME}:${AGENT}-${AGENT_VERSION}-${BASE_ALIAS}-${AICAGE_VERSION}"
          MANIFEST_LATEST_TAG="${IMAGE_NAME}:${AGENT}-${BASE_ALIAS}"
          MANIFEST_TEST_TAG="${MANIFEST_VERSION_TAG}-test"
          {
            echo "IMAGE_NAME=${IMAGE_NAME}"
            echo "MANIFEST_VERSION_TAG=${MANIFEST_VERSION_TAG}"
            echo "MANIFEST_LATEST_TAG=${MANIFEST_LATEST_TAG}"
            echo "MANIFEST_TEST_TAG=${MANIFEST_TEST_TAG}"
          } >> "$GITHUB_OUTPUT"
          {
            echo "IMAGE_NAME=${IMAGE_NAME}"
            echo "MANIFEST_VERSION_TAG=${MANIFEST_VERSION_TAG}"
            echo "MANIFEST_LATEST_TAG=${MANIFEST_LATEST_TAG}"
            echo "MANIFEST_TEST_TAG=${MANIFEST_TEST_TAG}"
          } >> "$GITHUB_ENV"

      - name: Download amd64 digest
        uses: actions/download-artifact@v4
        with:
          name: digest-${{ matrix.agent }}-${{ matrix.base }}-amd64
          path: digest/amd64

      - name: Download arm64 digest
        uses: actions/download-artifact@v4
        with:
          name: digest-${{ matrix.agent }}-${{ matrix.base }}-arm64
          path: digest/arm64

      - name: Load digests
        id: digests
        run: |
          set -euo pipefail
          DIGEST_AMD64="$(cat digest/amd64/digest.txt)"
          DIGEST_ARM64="$(cat digest/arm64/digest.txt)"
          {
            echo "AICAGE_IMAGE_DIGEST_amd64=${DIGEST_AMD64}"
            echo "AICAGE_IMAGE_DIGEST_arm64=${DIGEST_ARM64}"
          } >> "$GITHUB_ENV"

      - name: "Set up Buildx"
        uses: docker/setup-buildx-action@v3.11.1
        with:
          driver: docker-container

      - name: "Log in to Docker Hub"
        uses: docker/login-action@v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "Publish: Create and push multi-arch manifest"
        id: build_manifest
        run: |
          set -euo pipefail
          docker buildx imagetools create \
              --tag "${MANIFEST_TEST_TAG}" \
              "${AICAGE_IMAGE_DIGEST_amd64}" \
              "${AICAGE_IMAGE_DIGEST_arm64}"

      - name: Install Cosign
        uses: sigstore/cosign-installer@v4.0.0

      - name: "Publish: Sign multi-arch manifest"
        run: |
          set -euo pipefail
          cosign sign --yes \
            "${MANIFEST_TEST_TAG}"

      - name: "Test: Verify multi-arch manifest signature"
        run: |
          set -euo pipefail
          cosign verify \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            --certificate-identity-regexp \
              "^https://github.com/${GITHUB_REPOSITORY}/.github/workflows/.*@refs/.*/.*$" \
            "${MANIFEST_TEST_TAG}"

      - name: "Publish: Set tags for multi-arch manifest"
        run: |
          set -euo pipefail
          # Promote the already-built & provenanced artifact by digest (no rebuild)
          docker buildx imagetools create \
            --tag "${MANIFEST_VERSION_TAG}" \
            --tag "${MANIFEST_LATEST_TAG}" \
            "${MANIFEST_TEST_TAG}"

      - name: Install ORAS
        uses: oras-project/setup-oras@v1

      - name: Delete test image tag
        run: |
          set -euo pipefail
          oras manifest delete "${MANIFEST_TEST_TAG}"
