name: Build Agent Image
run-name: Build agent image (${{ inputs.agent }}-${{ inputs.base }})

"on":
  workflow_call:
    inputs:
      base:
        description: Base alias to build (matches bases/<alias>)
        required: true
        type: string
      agent:
        description: Agent alias to build (matches agents/<alias>)
        required: true
        type: string
      git_ref:
        description: Git ref to check out (tag/branch/SHA). Defaults to the workflow ref.
        required: true
        type: string
  workflow_dispatch:
    inputs:
      base:
        description: Base alias to build (matches bases/<alias>)
        required: true
        type: string
      agent:
        description: Agent alias to build (matches agents/<alias>)
        required: true
        type: string
      git_ref:
        description: Git ref to check out (tag/branch/SHA). Defaults to the workflow ref.
        required: false
        default: ""
        type: string

permissions:
  contents: read
  packages: write
  id-token: write
  actions: read

jobs:

  build:
    name: "${{ matrix.arch }}: Build and test ${{ inputs.base }}-${{ inputs.agent }}"
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            platform: linux/amd64
            runner: ubuntu-latest
          - arch: arm64
            platform: linux/arm64
            runner: ubuntu-24.04-arm
    env:
      PLATFORM: ${{ matrix.platform }}
      ARCH_SUFFIX: ${{ matrix.arch }}
      BASE_ALIAS: ${{ inputs.base }}
      AGENT: ${{ inputs.agent }}
      ROOT_DIR: ${{ github.workspace }}
      AICAGE_VERSION: ${{ inputs.git_ref || github.ref_name }}
    outputs:
      INDEX_DIGEST_amd64: ${{ steps.out-amd64.outputs.INDEX_DIGEST }}
      INDEX_DIGEST_arm64: ${{ steps.out-arm64.outputs.INDEX_DIGEST }}
      IMAGE_REF: ${{ steps.config.outputs.IMAGE_REF }}
      VERSION_TAG: ${{ steps.config.outputs.VERSION_TAG }}
      PURPOSE_TAG: ${{ steps.config.outputs.PURPOSE_TAG }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1
        with:
          ref: ${{ inputs.git_ref || github.ref }}

      - name: Install Cosign
        uses: sigstore/cosign-installer@v4.0.0

      - name: Load config file
        id: config
        run: |
          set -euo pipefail
          source scripts/common.sh
          load_config_file
          if is_agent_field_true "${AGENT}" build_local; then
            echo "Agent '${AGENT}' is non-redistributable; build.yml should not run for it." >&2
            exit 1
          fi
          AGENT_VERSION="$(agents/${AGENT}/version.sh)"
          if [[ -z "${AGENT_VERSION}" ]]; then
            echo "Agent version is empty for ${AGENT}" >&2
            exit 1
          fi
          BASE_IMAGE="${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_BASE_REPOSITORY}:${BASE_ALIAS}"
          IMAGE_REF="${AICAGE_IMAGE_REGISTRY}/${AICAGE_IMAGE_REPOSITORY}"
          VERSION_TAG="${AGENT}-${AGENT_VERSION}-${BASE_ALIAS}-${AICAGE_VERSION}"
          PURPOSE_TAG="${AGENT}-${BASE_ALIAS}"
          IMAGE_TEST_TAG="${IMAGE_REF}:${VERSION_TAG}-${ARCH_SUFFIX}-test"

          BASES_TMPDIR="$(download_bases_archive)"
          ALLOWED_BASES="$(get_bases "${AGENT}" "${BASES_TMPDIR}/bases" "${BASE_ALIAS}")"
          if ! printf '%s\n' "${ALLOWED_BASES}" | grep -Fxq "${BASE_ALIAS}"; then
            echo "Base '${BASE_ALIAS}' is excluded for agent '${AGENT}'" >&2
            exit 1
          fi
          {
            echo "BASE_IMAGE=${BASE_IMAGE}"
            echo "IMAGE_REF=${IMAGE_REF}"
            echo "VERSION_TAG=${VERSION_TAG}"
            echo "PURPOSE_TAG=${PURPOSE_TAG}"
            echo "IMAGE_TEST_TAG=${IMAGE_TEST_TAG}"
          } >> "$GITHUB_OUTPUT"
          {
            echo "BASE_IMAGE=${BASE_IMAGE}"
            echo "IMAGE_REF=${IMAGE_REF}"
            echo "VERSION_TAG=${VERSION_TAG}"
            echo "PURPOSE_TAG=${PURPOSE_TAG}"
            echo "IMAGE_TEST_TAG=${IMAGE_TEST_TAG}"
          } >> "$GITHUB_ENV"

      - name: "Set up Buildx"
        uses: docker/setup-buildx-action@v3.11.1
        with:
          driver: docker-container

      - name: "Log in to Docker Hub"
        uses: docker/login-action@v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build test image tag
        id: build_image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          provenance: true
          build-args: |
            BASE_IMAGE=${{ env.BASE_IMAGE }}
            AGENT=${{ env.AGENT }}
          tags: |
            ${{ steps.config.outputs.IMAGE_TEST_TAG }}
          labels: |
            org.opencontainers.image.description=Agent image for ${{ env.AGENT }}

      - name: "Test: Setup BATS testing framework"
        uses: mig4/setup-bats@v1.2.0

      - name: "Test: Run smoke suites on final image"
        run: |
          set -euo pipefail
          scripts/test.sh \
            --image "${IMAGE_REF}@${{ steps.build_image.outputs.digest }}" \
            --agent "${AGENT}"

      - name: Export digest (amd64)
        id: out-amd64
        if: matrix.arch == 'amd64'
        run: |
          set -euo pipefail
          (
            echo "INDEX_DIGEST=${{ steps.build_image.outputs.digest }}"
          ) | tee /dev/stderr >> "$GITHUB_OUTPUT"

      - name: Export digest (arm64)
        id: out-arm64
        if: matrix.arch == 'arm64'
        run: |
          set -euo pipefail
          (
            echo "INDEX_DIGEST=${{ steps.build_image.outputs.digest }}"
          ) | tee /dev/stderr >> "$GITHUB_OUTPUT"

  multiarch:
    name: Run multi-arch sign/provenance/publish
    needs: build
    uses: aicage/github-actions/.github/workflows/multiarch-image-build-sign-provenance.yml@0.2.0
    with:
      image_ref: ${{ needs.build.outputs.IMAGE_REF }}
      version_tag: ${{ needs.build.outputs.VERSION_TAG }}
      purpose_tag: ${{ needs.build.outputs.PURPOSE_TAG }}
      index_digest_amd64: ${{ needs.build.outputs.INDEX_DIGEST_amd64 }}
      index_digest_arm64: ${{ needs.build.outputs.INDEX_DIGEST_arm64 }}
      actions_ref: 0.2.0
    secrets: inherit
