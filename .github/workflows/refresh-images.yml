name: Refresh Agent Images (Tool Versions)
run-name: Refresh tool-version images (${{ github.ref_name }})

"on":
  push:
    tags:
      - "*"
  # The scheduler on GitHub is not reliable enough so a cron job at cron-job.org triggers this by workflow_dispatch
  #   schedule:
  #     - cron: "7,27,47 * * * *"
  workflow_dispatch: {}

concurrency:
  group: refresh-images
  cancel-in-progress: false

jobs:
  refresh:
    name: Refresh tool/base images
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
      REF: ${{ github.ref }}
      ROOT_DIR: ${{ github.workspace }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: Install pipeline dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq skopeo

      - name: Dispatch builds when needed
        run: |
          set -euo pipefail
          source scripts/common.sh
          source scripts/refresh-images-lib.sh
          load_config_file

          FORCE_BUILD="false"
          if [[ "${GITHUB_EVENT_NAME}" == "push" ]]; then
            FORCE_BUILD="true"
          fi

          BASES_TMPDIR="$(download_bases_archive)"
          BASE_ALIASES="$(list_base_aliases "${BASES_TMPDIR}/bases")"

          for dir in tools/*; do
            [ -d "${dir}" ] || continue
            TOOL="$(basename "${dir}")"
            TOOL_VERSION="$(tools/${TOOL}/version.sh)"
            if [[ -z "${TOOL_VERSION}" ]]; then
              echo "Tool version is empty for ${TOOL}" >&2
              exit 1
            fi

            for BASE_ALIAS in ${BASE_ALIASES}; do
              if [[ "${FORCE_BUILD}" == "true" ]]; then
                echo "Forcing build for ${TOOL} (${BASE_ALIAS}) due to ${GITHUB_EVENT_NAME}"
                gh workflow run build.yml --ref "${REF}" -f tool="${TOOL}" -f base="${BASE_ALIAS}"
              elif needs_rebuild "${TOOL}" "${BASE_ALIAS}" "${TOOL_VERSION}"; then
                echo "Dispatching ${TOOL} (${BASE_ALIAS}) for ${REF}"
                gh workflow run build.yml --ref "${REF}" -f tool="${TOOL}" -f base="${BASE_ALIAS}"
              else
                # status from needs_rebuild
                status=$?
                if [[ "${status}" -eq 1 ]]; then
                  echo "Up-to-date ${TOOL} (${BASE_ALIAS})"
                else
                  echo "Failed to determine rebuild for ${TOOL} (${BASE_ALIAS})" >&2
                  exit 1
                fi
              fi
            done
          done
