name: Refresh Agent Images (Tool Versions)
run-name: Refresh tool-version images (${{ github.ref_name }})

"on":
  push:
    tags:
      - "*"
  schedule:
    - cron: "*/20 * * * *"
  workflow_dispatch: {}

concurrency:
  group: refresh-images
  cancel-in-progress: true

jobs:
  refresh:
    name: Refresh tool/base images
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
      REF: ${{ github.ref }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: "Test: Set up Python"
        uses: actions/setup-python@v6.1.0
        with:
          python-version: "3.x"

      - name: "Test: Install lint deps"
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: "Test: Run linters (yamllint, ruff, pymarkdown)"
        run: |
          yamllint .
          ruff check .
          pymarkdown --config .pymarkdown.json scan .

      - name: Install pipeline dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq skopeo

      - name: Dispatch builds when needed
        run: |
          set -euo pipefail
          source scripts/common.sh
          source scripts/refresh-images-lib.sh
          load_config_file

          FORCE_BUILD="false"
          if [[ "${GITHUB_EVENT_NAME}" == "push" || "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            FORCE_BUILD="true"
          fi

          BASE_ALIASES="$(discover_base_aliases)"

          for dir in tools/*; do
            [ -d "${dir}" ] || continue
            TOOL="$(basename "${dir}")"
            TOOL_VERSION="$(tools/${TOOL}/version.sh)"
            if [[ -z "${TOOL_VERSION}" ]]; then
              echo "Tool version is empty for ${TOOL}" >&2
              exit 1
            fi

            for BASE_ALIAS in ${BASE_ALIASES}; do
              if [[ "${FORCE_BUILD}" == "true" ]]; then
                echo "Forcing build for ${TOOL} (${BASE_ALIAS}) due to ${GITHUB_EVENT_NAME}"
                gh workflow run build.yml --ref "${REF}" -f tool="${TOOL}" -f base="${BASE_ALIAS}"
              elif needs_rebuild "${TOOL}" "${BASE_ALIAS}" "${TOOL_VERSION}"; then
                echo "Dispatching ${TOOL} (${BASE_ALIAS}) for ${REF}"
                gh workflow run build.yml --ref "${REF}" -f tool="${TOOL}" -f base="${BASE_ALIAS}"
              else
                echo "Up-to-date ${TOOL} (${BASE_ALIAS})"
              fi
            done
          done
