name: Build All Agent Images
run-name: Dispatch all tools (${{ github.ref_name }})

"on":
  push:
    tags:
      - "*"
  schedule:
    - cron: "0 3 * * 1"
  workflow_dispatch: {}

concurrency:
  group: build-all
  cancel-in-progress: true

jobs:
  dispatch:
    name: Dispatch tool builds
    runs-on: ubuntu-latest
    env:
      REF: ${{ github.ref }}
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: "Test: Set up Python"
        uses: actions/setup-python@v6.1.0
        with:
          python-version: "3.x"

      - name: "Test: Install lint deps"
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: "Test: Run linters (yamllint, ruff, pymarkdown)"
        run: |
          yamllint .
          ruff check .
          pymarkdown --config .pymarkdown.json scan .

      - name: Dispatch per-tool builds
        run: |
          set -euo pipefail
          for dir in tools/*; do
            [ -d "${dir}" ] || continue
            TOOL="$(basename "${dir}")"
            echo "Dispatching ${TOOL} for ${REF}"
            gh workflow run build-tool.yml --ref "${REF}" -f tool="${TOOL}"
          done
